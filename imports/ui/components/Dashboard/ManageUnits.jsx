/* eslint-disable no-unused-expressions */
/* eslint-disable no-case-declarations */
/* eslint-disable default-case */
import { Session } from "meteor/session";
import React, { Component, Fragment } from "react";
import { withTracker } from "meteor/react-meteor-data";
import i18n from "meteor/universe:i18n";
import M from "materialize-css";
import PropTypes from "prop-types";
import { _Courses } from "../../../api/courses/courses";
import { _Units } from "../../../api/units/units";
import { Titles } from "../../../api/settings/titles";
import {
  handleCheckboxChange,
  handleCheckAll,
  getCheckBoxValues
} from "../Utilities/CheckBoxHandler.jsx";
import Pagination, {
  getPageNumber,
  getQuery
} from "../Utilities/Pagination/Pagination.jsx";
import { SearchField } from "../Utilities/Utilities.jsx";
import Search from "../Utilities/Search/Search.jsx";
import UploadWrapper from "../../../ui/modals/UploadWrapper.jsx";
import MainModal from "../../../ui/modals/MainModal"; // eslint-disable-line
import * as config from "../../../../config.json";
import { formatText } from "../../utils/utils";
import { ThemeContext } from "../../containers/AppWrapper"; // eslint-disable-line

export const T = i18n.createComponent();
// this lists what a specific course contains

export class ManageUnits extends Component {
  constructor(props) {
    super(props);
    this.SESSION_RESULTS = "UNIT_RESULTS"; //
    this.SESSION_RESULTS_COUNT = "UNIT_RESULTS_COUNT"; //
    this.itemPerPage = 10;
    this.totalResults = 0;
    this.queryParams = [{ param: "q" }];
    this.handleSubmit = this.handleSubmit.bind(this);
    this.state = {
      isOpen: false,
      modalIdentifier: "", // School Id
      title: "", // Add School or Edit
      confirm: "",
      reject: "",
      name: "",
      ids: [],
      table_title: "",
      sub_title: "",
      description: ""
    };
    this.computation = "";
  }

  static propTypes = {
    titles: PropTypes.object,
    course: PropTypes.object
  };

  componentDidMount() {
    this._ismounted = true;
    this.computation = Tracker.autorun(() => {
      if (this._ismounted) {
        this.setState({
          data: Session.get("UNIT_RESULTS"),
          resultsCount: Session.get("UNIT_RESULTS_COUNT")
        });
      }
    });
    // don't clean the courseId on unmount
    Session.set("courseId", FlowRouter.getQueryParam("cs"));
    window.scrollTo(0, 0);
  }

  componentWillUnmount() {
    this.computation.stop();
    Session.set({
      UNIT_RESULTS: "",
      UNIT_RESULTS_COUNT: ""
    });
    this.setState({
      data: "",
      resultsCount: ""
    });
    this._ismounted = false;
  }

  // close the modal, and clear the states;
  closeModal = () => {
    this.setState({
      isOpen: false,
      modalIdentifier: "", // Topic Id
      modalType: "", // Add or Edit
      title: "", // Add Topic or Edit Topic
      confirm: "",
      reject: "",
      name: ""
    });
  };

  getDescription = ({ target: { value } }) => {
    this.setState({
      description: value
    });
  };

  // ide => modalType, id => schoolId
  toggleEditModal = (ide, id = "", name = "", desc = "") => {
    // check if the user has full rights
    if (!Roles.userIsInRole(Meteor.userId(), ["admin"])) {
      return;
    }

    this.name = name;
    this.id = id;
    this.desc = desc;

    switch (ide) {
      case "edit":
        this.setState({
          modalIdentifier: this.id,
          modalType: ide,
          title: `Edit ${Session.get("sub_unit_title")}`,
          confirm: "Save",
          reject: "Close",
          name: this.name,
          description: this.desc
        });

        break;

      case "del":
        const unit = getCheckBoxValues("chk");
        const count = unit.length;
        const _name = count > 1 ? "units" : "unit";
        if (count < 1) {
          M.toast({
            html: "<span>Please check atleast one unit</span>",
            classes: "red"
          });
          return;
        }
        this.setState({
          modalIdentifier: "id",
          modalType: ide,
          title: `Are you sure to delete ${count} ${_name}`,
          confirm: "Yes",
          reject: "No",
          ids: unit
        });
        break;
      case "upload":
        this.setState({
          modalIdentifier: "",
          modalType: ide,
          title: `Upload resource for ${Session.get("courseName")} `,
          confirm: "Save", // this should be out
          reject: "Close" // this too should be out
        });
        break;
      case "field":
        this.setState({
          title: "Edit Table titles on this page",
          confirm: "Save",
          reject: "Close",
          modalType: ide,
          table_title: id,
          sub_title: name
        });
        break;
    }
    this.setState(prevState => ({ isOpen: !prevState.isOpen }));
  };

  renderUnits() {
    let count = 1;
    const { data, resultsCount } = this.state;
    if (!data) {
      return null;
    }
    this.totalResults = resultsCount;
    return data.map(unit => (
      <Unit
        key={unit._id}
        href={`/dashboard/edit_unit/${unit._id}`}
        count={count++}
        unit={{
          _id: unit._id,
          name: unit.name,
          createdBy: unit.createdBy,
          createdAt: moment(unit.createdAt).format("YYYY-MM-DD")
        }}
        EditUnit={e =>
          this.toggleEditModal("edit", unit._id, unit.name, unit.unitDesc, e)
        }
      />
    ));
  }

  // edit course unit
  handleSubmit(event) {
    event.preventDefault();
    const { modalType, ids, modalIdentifier, description } = this.state;
    const { target } = event;
    switch (modalType) {
      case "edit":
        const unit = target.unit.value;
        Meteor.call("unit.update", modalIdentifier, unit, description, err => {
          err
            ? // eslint-disable-next-line
              (M.toast({ html: `<span>${err.reason}</span>`, classes: "red" }),
              Meteor.call(
                "logger",
                formatText(err.message, Meteor.userId(), "unit-edit"),
                "error"
              ))
            : Meteor.call("updateSearch", modalIdentifier, unit, err => {
                err
                  ? M.toast({
                      html: `<span>${err.reason}</span>`,
                      classes: "red"
                    })
                  : M.toast({
                      html: `<span>${unit} successfully updated</span>`,
                      classes: "green darken-1"
                    });
              });
        });
        break;

      case "del":
        let count = 0;
        ids.forEach(id => {
          Meteor.call("unit.remove", id, err => {
            count += 1;
            err
              ? (M.toast({
                  html: `<span>${err.reason}</span>`,
                  classes: "red"
                }),
                Meteor.call(
                  "logger",
                  formatText(err.message, Meteor.userId(), "unit-remove"),
                  "error"
                ))
              : Meteor.call("removeSearchData", id, err => {
                  err
                    ? M.toast({
                        html: `<span>${err.reason}</span>`,
                        classes: "red"
                      })
                    : Meteor.call("insertDeleted", id, err => {
                        err
                          ? M.toast({
                              html: `<span>${err.reason}</span>`,
                              classes: "red"
                            })
                          : M.toast({
                              html: `<span>${unit} successfully Deleted</span>`,
                              classes: "green darken-1"
                            });
                      });
                });
          });
        });
        break;
      case "field":
        return;
    }

    // close the modal when done;
    this.closeModal();
  }

  getUnits() {
    const query = getQuery(this.queryParams, true, true, "q");
    let searchParams = [{ name: query }];
    if (query === "") {
      searchParams = [{}];
    }
    return (
      <Search
        limit={this.itemPerPage}
        skip={getPageNumber(this.itemPerPage)}
        coll={_Units}
        session={this.SESSION_RESULTS}
        data={searchParams}
        criteria={"OR"}
      />
    );
  }

  routeToCourses = e => {
    e.preventDefault();
    return FlowRouter.go("/dashboard/course");
  };

  render() {
    const { course, titles } = this.props;
    const {
      isOpen,
      title,
      confirm,
      reject,
      modalType,
      name,
      description
    } = this.state;
    // eslint-disable-next-line
    let courseId,
      newTitle,
      newSubTitle,
      language,
      courseName = null;
    if (course) {
      courseId = course._id;
      language = course.details.language; // eslint-disable-line
      courseName = course.name;
      Session.set("courseName", courseName);
    }
    if (titles) {
      newTitle = titles.title;
      newSubTitle = titles.sub_title;
      Session.set({
        unit_title_id: titles._id,
        sub_unit_title: newSubTitle,
        unit_title: newTitle
      });
    }

    return (
      <ThemeContext.Consumer>
        {({ state }) => (
          <Fragment>
            {this.getUnits()}

            {this.state.modalType === "upload" ? (
              <UploadWrapper
                show={isOpen}
                close={this.closeModal}
                title={title}
              />
            ) : (
              <MainModal
                show={isOpen}
                onClose={this.closeModal}
                subFunc={this.handleSubmit}
                title={title}
                confirm={confirm}
                reject={reject}
              >
                {modalType === "del" ? (
                  ""
                ) : (
                  <Fragment>
                    <div className="input-field">
                      <input
                        placeholder="Name of Unit"
                        type="text"
                        defaultValue={name}
                        className="validate clear"
                        style={{
                          color: state.isDark ? "#F5FAF8" : "#000000"
                        }}
                        required
                        name="unit"
                      />
                    </div>
                    <div className="input-field">
                      <textarea
                        name="descr"
                        className="unitdesc clear materialize-textarea"
                        style={{
                          color: state.isDark ? "#F5FAF8" : "#000000"
                        }}
                        placeholder="Add Unit Description"
                        value={description}
                        onChange={e => this.getDescription(e)}
                        required
                      />
                    </div>
                  </Fragment>
                )}
              </MainModal>
            )}
            <div className="m1" />
            <div
              className="col m9 s11"
              style={{
                backgroundColor: state.isDark ? state.mainDark : "#FFFFFF",
                color: state.isDark ? "#F5FAF8" : "#000000"
              }}
            >
              <div className="row">
                <div className="">
                  <h4>
                    {`${Session.get("sub_unit_title")} for ${courseName}`}{" "}
                  </h4>
                </div>
                <div className="col m8 ">
                  <SearchField
                    action={"/dashboard/Units/"}
                    name={"units"}
                    placeholder={"search unit by name"}
                    query={"q"}
                  />
                </div>
              </div>

              <div className="row">
                <div className="col m3">
                  <button
                    className="btn grey darken-3 fa fa-angle-left"
                    onClick={e => this.routeToCourses(e)}
                  >
                    <a href={""} className="white-text">
                      {` ${newTitle}`}
                    </a>
                  </button>
                </div>
                <div className="col m3">
                  <button
                    className="btn red darken-2"
                    onClick={e => this.toggleEditModal("del", e)}
                  >
                    {" "}
                    <T>common.actions.delete</T>
                  </button>
                </div>
                <div className="col m2">
                  <a href={`/dashboard/unit/${courseId}?y=${language}`}>
                    <button className="btn grey ">
                      {" Add Unit "}
                      <T>common.actions.new</T>
                    </button>
                  </a>
                </div>
                <div className="col 4">
                  <button
                    className="btn fa fa-upload green darken-4 "
                    onClick={e => this.toggleEditModal("upload", e)}
                  >
                    {" "}
                    <T>common.actions.addreference</T>
                  </button>
                </div>
              </div>

              <table className="highlight">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>{newSubTitle}</th>
                    <th>
                      <T>common.actions.createdAt</T>
                    </th>
                    <th>{`Edit ${newSubTitle}`}</th>
                    <th>{`Manage sub-${newSubTitle}`}</th>
                    <th onClick={handleCheckAll.bind(this, "chk-all", "chk")}>
                      <label>
                        <input type="checkbox" className=" chk-all" readOnly />
                        <T>common.actions.check</T>
                      </label>
                    </th>
                  </tr>
                </thead>
                <tbody>{this.renderUnits()}</tbody>
              </table>

              <Pagination
                path={"/dashboard/Units"}
                itemPerPage={this.itemPerPage}
                query={getQuery(this.queryParams, true)}
                totalResults={this.totalResults}
              />
            </div>
          </Fragment>
        )}
      </ThemeContext.Consumer>
    );
  }
}

const handleUrl = (e, id) => {
  // id => unit_id
  if (config.isHighSchool) {
    FlowRouter.go(`/dashboard/isHighSchool/edit_unit/${id}`);
  } else {
    FlowRouter.go(`/dashboard/edit_unit/${id}`);
  }
};
export const Unit = ({ EditUnit, count, unit: { _id, name, createdAt } }) => (
  <tr key={_id} className="link-unit">
    <td>{count}</td>
    <td onClick={e => handleUrl(e, _id)}>{name}</td>
    <td>{createdAt}</td>
    <td>
      <a href="" className="fa fa-pencil" onClick={EditUnit} />
    </td>
    <td>
      <a href={""} onClick={e => handleUrl(e, _id)} className="fa fa-pencil" />
    </td>
    <td onClick={handleCheckboxChange.bind(this, _id)}>
      <label htmlFor={_id}>
        <input type="checkbox" id={_id} className={`chk chk${_id}`} />
        <span />
      </label>
    </td>
  </tr>
);

Unit.propTypes = {
  EditUnit: PropTypes.func.isRequired,
  count: PropTypes.number.isRequired,
  unit: PropTypes.object.isRequired
};

export default withTracker(() => {
  Meteor.subscribe("searchUnits", Session.get("courseIde"));
  Meteor.subscribe("courses");
  Meteor.subscribe("deleted");
  Meteor.subscribe("titles");
  return {
    course: _Courses.findOne({ _id: Session.get("courseIde") }),
    titles: Titles.findOne({}),
    Units: []
  };
})(ManageUnits);
